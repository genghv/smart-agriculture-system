# 项目开源规划文档

## 1. 项目概述

本项目是一个集成AI决策、权限管理、数据加密和数据库系统的智能云平台，主要用于农业、生态等领域的数据分析与决策支持。系统采用模块化设计，支持多专家并行推理、细粒度权限控制、安全的数据传输和模型控制程序(MCP)架构，实现了大模型与本地控制程序的无缝集成。

**后期计划**：将实现本地模型部署能力，训练多款针对农业场景的小模型，包括但不限于作物生长预测模型、病虫害识别模型、土壤分析模型等，以降低对外部API的依赖并提高系统响应速度。

## 2. 核心功能

### 2.1 AI决策编排
- 基于多专家Agent的并行推理与仲裁
- 动态专家选择与任务分发
- 工单生命周期管理
- 决策日志记录与追踪

#### AI推理模式实现
系统支持多种推理模式，具体实现位于`cloud_backend/functions/src/ai/llm.py`：

1. **ReAct推理引擎** (`ReactAgent`类)
   - 实现原理：通过"思考-行动-观察"循环进行推理
   - 关键特性：支持多步骤推理，每步可调用工具并根据结果调整策略
   - 应用场景：复杂问题解决，需要顺序决策的场景
   - 核心方法：`execute()`实现推理循环，`_build_react_prompt()`构建动态提示词，`_extract_tool_calls()`提取工具调用

2. **Function Schema推理引擎** (`FunctionSchemaAgent`类)
   - 实现原理：基于函数调用的结构化输出推理
   - 关键特性：直接生成工具调用请求，支持多工具并行调用
   - 应用场景：明确需要工具辅助的场景，结构化数据处理
   - 核心方法：`_build_messages()`构建消息列表，`_execute_tools()`执行工具链，`_process_tool_results()`处理工具结果

3. **动态模式选择**
   - 通过`agent_mode`参数控制（'react'或'function'）
   - 默认使用Function Schema模式，复杂场景可切换为ReAct模式
   - 工作流中通过`task_package`的`agent_mode`字段指定

### 2.2 权限管理系统
- 基于角色的访问控制(RBAC)
- 细粒度权限划分(读/写/管理)
- 多级别资源保护
- 用户角色与权限动态分配
- 表级权限分离设计

### 2.3 加密与安全
- 双层数据加密机制(对称加密+SigV4)
- 分层密钥管理(Master Key、DEK、KEK)
- 安全的数据传输通道
- 数据库访问权限控制
- JWT令牌管理与验证
- CA证书管理与用户认证

### 2.4 数据库系统
- SQLite轻量级数据库
- 多表设计与权限分离
- 高效的查询执行引擎
- 数据完整性与一致性保障

### 2.5 模型控制程序(MCP)
- 工具注册与管理
- 工具执行与参数验证
- 权限沙箱控制
- 提示词生成与优化
- 大模型与本地程序通信桥接

## 3. 技术栈

- **核心语言**: Python 3.11+
- **数据库**: SQLite
- **异步框架**: asyncio
- **加密库**: cryptography, boto3
- **LLM集成**: DeepSeek API
- **权限框架**: 自定义RBAC实现
- **依赖管理**: pip
- **Web框架**: Flask/FastAPI (可选)
- **认证**: JWT, SigV4
- **机器学习框架**: TensorFlow/PyTorch (计划引入)

## 4. 系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                      应用层 (Application Layer)                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │  Web UI/API │  │  移动端接口  │  │  边缘设备通信接口         │  │
│  └──────┬──────┘  └──────┬──────┘  └──────────┬────────────────┘  │
└─────────┼────────────────┼────────────────────┼────────────────────┘
          │                │                    │
┌─────────▼────────────────▼────────────────────▼────────────────────┐
│                      业务逻辑层 (Service Layer)                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │  AI编排器   │  │  权限管理器  │  │  工单服务                │  │
│  └──────┬──────┘  └──────┬──────┘  └──────────┬────────────────┘  │
└─────────┼────────────────┼────────────────────┼────────────────────┘
          │                │                    │
┌─────────▼────────────────▼────────────────────▼────────────────────┐
│                      数据访问层 (Data Access Layer)               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │  LLM客户端  │  │  MCP中间层   │  │  数据库管理器            │  │
│  │  (带加密)   │  │  (工具注册/执行)│  │  (权限分离)            │  │
│  └──────┬──────┘  └──────┬──────┘  └──────────┬────────────────┘  │
└─────────┼────────────────┼────────────────────┼────────────────────┘
          │                │                    │
┌─────────▼────────────────▼────────────────────▼────────────────────┐
│                      基础设施层 (Infrastructure Layer)            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │  LLM服务    │  │  加密模块    │  │  SQLite数据库           │  │
│  │ (DeepSeek)  │  │ (分层密钥)   │  │ (多表权限分离)          │  │
│  │ 本地模型    │  │             │  │                        │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## 5. 开源计划

### 5.1 核心目标
- **基础框架**: 发布项目基础架构，实现AI编排器、权限管理和MCP核心组件
- **完整功能**: 完善数据库系统、LLM集成加密和安全系统重构
- **社区生态**: 收集反馈、优化性能、支持多模型集成和本地模型部署
- **农业应用**: 开发农业专用小模型，包括作物生长预测、病虫害识别等

## 6. 技术学习路线

为了更好地理解和参与本项目，建议按以下路线学习相关技术:

1. **Python基础**
   - 核心语法和数据结构
   - 面向对象编程
   - 异步编程(asyncio)

2. **数据库技术**
   - SQLite基础操作
   - SQL查询优化
   - 数据库设计原则
   - 权限管理

3. **安全与加密**
   - 密码学基础
   - 常见加密算法(AES, RSA, HMAC等)
   - 安全编程实践
   - 密钥管理系统设计
   - 双向信任机制实现
   - JWT和身份认证

4. **AI与LLM集成**
   - 大语言模型基础
   - API调用与集成
   - 提示工程
   - 工具调用机制
   - 推理引擎设计
   - 小模型训练与部署

5. **系统架构**
   - 微服务设计
   - 模块化开发
   - 接口设计原则
   - 中间件设计

## 7. 个人技术成长与项目开发

本项目开发过程中，通过AI辅助开发，倒逼团队不断学习和掌握新技术：

- **加密技术**: 深入学习加密算法原理，实现分层密钥管理系统
- **双向信任机制**: 研究并实现系统组件间的双向认证与信任建立
- **AI推理引擎**: 探索不同推理模式的实现与优化
- **权限系统**: 设计并实现细粒度的权限控制机制

这种学习与实践相结合的方式，不仅提升了个人技术能力，也确保了项目的技术深度和安全性。

## 8. 贡献指南

我们欢迎所有形式的贡献，包括代码提交、文档改进、问题反馈等。贡献前请阅读以下指南:

1. **代码贡献流程**
   - Fork本仓库
   - 创建特性分支
   - 提交代码变更
   - 创建Pull Request
   - 代码审查与合并

2. **代码规范**
   - 遵循PEP 8风格指南
   - 添加适当的文档和注释
   - 编写单元测试
   - 确保代码可维护性

3. **问题反馈**
   - 使用GitHub Issues提交问题
   - 提供详细的错误信息和复现步骤
   - 标签分类(BUG/FEATURE/DOCUMENTATION)

## 9. 联系方式

- 邮箱: [gengxberww@petalmail.com]

---

更新日期: 2025-08-10 15:30:22